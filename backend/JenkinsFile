def REPO = "https://github.com/TIC-Para-Bien/hospitalizados-hoteles.git"

node {
    stage('Pull repository') {
        git credentialsId: 'github-tpb', url: "$REPO"
    }

    stage('Build') {
        withEnv(['JAVA_HOME=/usr/lib/jvm/java-11-openjdk']) {
            withMaven(maven: 'Maven 3.5') {
                sh "mvn clean compile"
            }
        }
    }

    stage('Unit tests') {
        withEnv(['JAVA_HOME=/usr/lib/jvm/java-11-openjdk']) {
            withMaven(maven: 'Maven 3.5') {
                sh "mvn test"
            }
        }
    }

    stage('Integration tests') {
        withEnv(['JAVA_HOME=/usr/lib/jvm/java-11-openjdk']) {
            withMaven(maven: 'Maven 3.5') {
                sh "mvn verify -P integration-test -Dtest=BlakenTest -DfailIfNoTests=false"
            }
        }
    }

    stage('Acceptance tests') {
        withEnv(['JAVA_HOME=/usr/lib/jvm/java-11-openjdk']) {
            withMaven(maven: 'Maven 3.5') {
                sh "mvn verify -P acceptance-test -Dtest=BlakenTest -DfailIfNoTests=false"
            }
        }
    }

//    stage('Sonar') {
//       withSonarQubeEnv(credentialsId: 'sonar-token', installationName: 'sonar-tpb') {
//            sh 'mvn sonar:sonar'
//        }
//    }

//    stage('Snyk dependencies') {
//      snykSecurity failOnIssues: false, organisation: 'ibai.eus', projectName: 'hospitalizacion-hoteles', snykInstallation: 'snyk-latest', snykTokenId: 'snyk-tpb'
//    }

    stage('Package JAR') {
        withEnv(['JAVA_HOME=/usr/lib/jvm/java-11-openjdk']) {
            withMaven(maven: 'Maven 3.5') {
                sh "mvn package spring-boot:repackage -DskipTests"
            }
        }
    }
}
